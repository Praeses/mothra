<!DOCTYPE html>  <html> <head>   <title>faye.ad.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="backbone-faye-client-store.html">                 backbone-faye-client-store.coffee               </a>                                           <a class="source" href="faye-client-auth.html">                 faye-client-auth.coffee               </a>                                           <a class="source" href="jquery.image-dropout.html">                 jquery.image-dropout.coffee               </a>                                           <a class="source" href="backbone-faye-server-store.html">                 backbone-faye-server-store.coffee               </a>                                           <a class="source" href="faye.ad.html">                 faye.ad.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               faye.ad.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>The Active Directory</h2>

<p>Authentication has been done many times.  There are many ways of doing it.  We have
AD at our disposal so we are going to use it.  the <code>ActiveDirectory</code> class will 
manage communication to our AD instance.  NOTE: we need to put the settings in a config
file so that the details to connect to our AD do not exists in code.  The AD settings 
exist in the environment.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">ActiveDirectory</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>https://github.com/joewalnes/node-ldapauth </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@ldapauth = </span><span class="nx">require</span> <span class="s1">&#39;./ldapauth&#39;</span>
    <span class="vi">@config   = </span><span class="nx">require</span> <span class="s1">&#39;../../config&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Take in a <code>faye</code> object and add <code>this</code> as an extention</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind: </span><span class="nf">(bayeux) -&gt;</span>
    <span class="vi">@bayeux = </span><span class="nx">bayeux</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">addExtension</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Listing to  all incomming messages and  intercepting the <code>\/meta\/subscribe</code>
channel. This channel  is the one that  will need to be blocked  if the auth
fails.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">incoming: </span><span class="nf">(message, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Checking the message</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">!=</span> <span class="s1">&#39;/meta/subscribe&#39;</span>
      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>For our  AD auth we need  to pass in the  domain. If the user  typed it in
then we want to remove what they typed so that we do not duplicate it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">username = </span><span class="s2">&quot;intel\\#{ message.ext?.username.replace( /^intel\\/i, &#39;&#39; ) }&quot;</span> 
    <span class="nv">password = </span><span class="nx">message</span><span class="p">.</span><span class="nx">ext</span><span class="o">?</span><span class="p">.</span><span class="nx">password</span> </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>By adding  an object  to the  error property  of the  message we  can stop
communication on the socket.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">username</span> <span class="o">&amp;&amp;</span> <span class="nx">password</span>
      <span class="nx">@ldapauth</span><span class="p">.</span><span class="nx">authenticate</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nf">( err, result ) -&gt;</span>
        <span class="k">if</span> <span class="nx">err</span>
          <span class="nv">message.error = </span><span class="nx">err</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">result</span>
          <span class="nv">message.error = </span><span class="s1">&#39;Invalid stuff dude&#39;</span>
        <span class="nx">callback</span> <span class="nx">message</span>
    <span class="k">else</span>
      <span class="nv">message.error = </span><span class="s1">&#39;need username and password&#39;</span>
      <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Exposing the <code>ActiveDirectory</code> class to the outside world</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.ActiveDirectory = </span><span class="nx">ActiveDirectory</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 