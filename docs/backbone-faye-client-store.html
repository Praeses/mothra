<!DOCTYPE html>  <html> <head>   <title>backbone-faye-client-store.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="backbone-faye-client-store.html">                 backbone-faye-client-store.coffee               </a>                                           <a class="source" href="backbone-faye-server-store.html">                 backbone-faye-server-store.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-faye-client-store.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">require</span> <span class="s1">&#39;faye&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>The Store </h1>

<p>The Store is what will transfer the data back and forth between the client and
the  server. Faye  is used  for communication.  Faye handles  all of  the hard
stuff. It will  handle connection drops and reconnects. Also,  if data has not
been sent in  a while Faye will  handle sending this data  when the connection
has been re-established</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Store</span>
  <span class="nv">constructor: </span><span class="nf">(@channel, @options = { bayeux : &#39;/backbone-faye&#39;}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Setup the Faye client.  By default it will listen on <code>/backbone-faye</code>.
All communication will go through this faye client.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@bayeux   = </span><span class="k">new</span> <span class="nx">Faye</span><span class="p">.</span><span class="nx">Client</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">bayeux</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Subscribe  to the  channel  for  this store.  An  example  would be  using
the  plural name  of  the model  for  the  channel This  way  we can  have
each  collection seperated  on a  different channel  to help  simplify the
communication to the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">subscribe</span> <span class="nx">@channel</span><span class="p">,</span> <span class="nx">on_message</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Publishing  a message  to the  server. If  the message  is a  <code>function</code> the
system will  first convert it  to json and  then send the  message. Messages
should be json.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">(message, success, error) -&gt;</span>
    <span class="nv">message = </span><span class="nx">message</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>NOTE: need to  figure out a way  to determine if this worked  or not. This
should be in the documentation for the faye protocal.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@channel</span><span class="p">,</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is where we will sync our  client side models back up. The message from
the  server will  have  all  the information  needed.  Once  the message  is
received it will need to trigger the model update.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_message: </span><span class="nf">(data) -&gt;</span>
    <span class="nv">message = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Grab the key from the message. This will  tell us if the message was for a
collection update, model update, or another type of communication.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">key = </span><span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="o">or</span> <span class="nx">message</span><span class="p">.</span><span class="nx">collection</span> <span class="o">or</span> <span class="nx">message</span><span class="p">.</span><span class="nx">key</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If the message is from the channel then  we need to pull out the json from
the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span><span class="o">?</span>
      <span class="nv">publish = </span><span class="k">if</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span> <span class="o">is</span> <span class="nb">Object</span>
        <span class="nx">message</span><span class="p">.</span><span class="nx">data</span>
      <span class="k">else</span>
        <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Triggering  the  correct event  will  update  the  given model(s)  in  the
collection. This  will occur  when ever  anyone updates  any model  in the
system. Either client side or server side.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@trigger</span> <span class="s2">&quot;sync:#{ key }:data&quot;</span><span class="p">,</span> <span class="nx">publish</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h1>Backbone#sync</h1>

<p>The  sync method  is  what needs  to  be overridden  inorder  for backbone  to
communicate  with the  server. Again  all communication  is going  to go  over
<code>Faye</code> so all that  is needed here is to publish the  message accross the wire
and we are complete. The callbacks won't do anything right now due to how faye
handles communication.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Backbone.sync = </span><span class="nf">(method, model, success, error) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Wrap what we want to send to the  server in an object NOTE: Other params may
be needed to help identify more about what is going on here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">messsage = </span>
    <span class="nv">method: </span><span class="nx">method</span>
    <span class="nv">model: </span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Very simple  pass through  for the  faye server.  No work  is needed  on the
client side for any of the operations. We will just pass it through and then
update the records on the return message from the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">model</span><span class="p">.</span><span class="nx">fayeStorage</span><span class="p">.</span><span class="nx">write</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">success</span><span class="p">,</span> <span class="nx">error</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 