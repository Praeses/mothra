<!DOCTYPE html>  <html> <head>   <title>backbone-faye-client-store.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="backbone-faye-client-store.html">                 backbone-faye-client-store.coffee               </a>                                           <a class="source" href="faye-client-auth.html">                 faye-client-auth.coffee               </a>                                           <a class="source" href="jquery.image-dropout.html">                 jquery.image-dropout.coffee               </a>                                           <a class="source" href="backbone-faye-server-store.html">                 backbone-faye-server-store.coffee               </a>                                           <a class="source" href="faye.ad.html">                 faye.ad.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-faye-client-store.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>The Store </h1>

<p>The Store is what will transfer the data back and forth between the client and
the  server. Faye  is used  for communication.  Faye handles  all of  the hard
stuff. It will  handle connection drops and reconnects. Also,  if data has not
been sent in  a while Faye will  handle sending this data  when the connection
has been re-established</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Connecting the store to the outside world</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">Store = </span><span class="k">class</span> <span class="nx">Store</span>
  <span class="nv">constructor: </span><span class="nf">(channel, @options = { bayeux : &#39;/faye&#39;}) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Change the scope of <code>this</code> for the on_message method</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span> <span class="err">@</span><span class="p">,</span> <span class="s1">&#39;on_message&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>There are two channels.  One for communication from the client to the
server and another from the server back to the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@channel        = </span><span class="s1">&#39;/models/&#39;</span> <span class="o">+</span> <span class="nx">channel</span>
    <span class="vi">@server_channel = </span><span class="s1">&#39;/server/models/&#39;</span> <span class="o">+</span> <span class="nx">channel</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Setup the Faye client.  By default it will listen on <code>/faye</code>.
All communication will go through this faye client.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@bayeux = </span><span class="k">new</span> <span class="nx">Faye</span><span class="p">.</span><span class="nx">Client</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">bayeux</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>To enable authentication we include the Auth class with the store. It is a
faye extention that will verify the  user and allow communication over the
faye pipe</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@auth = </span><span class="k">new</span> <span class="nx">Auth</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Enabling the  auth is simple.  All that is needed  is to bind  the socket,
subscription and provide a callback when the auth fails</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@auth</span><span class="p">.</span><span class="nx">bind</span> <span class="nx">@bayeux</span><span class="p">,</span> <span class="nx">@server_channel</span><span class="p">,</span> <span class="nx">@on_message</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><em>write</em> will publish a message on  the model channel to the server. Messages
are simple <code>json</code> objects. There are two propertities to the message: method
and model. The  method expected are: <code>create</code>,  <code>update</code>, <code>read</code>, <code>readAll</code>,
and <code>destroy</code>. The model is either the collection or the single instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">write: </span><span class="nf">(message) -&gt;</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@channel</span><span class="p">,</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><em>on_message</em>  is where  we will  sync our  client side  models back  up. The
message  from the  server will  have all  the information  needed. Once  the
message  is received  it will  need to  trigger the  model update,  which is
handled nicely by backbone.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_message: </span><span class="nf">(message) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span> <span class="nx">message</span><span class="p">.</span><span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><em>read</em> handles two types. The first is where the model already exists in the
collection and the other is when the model doesn't exists. To handle both of
theses situations  all that is  needed to  do is check  to see if  the model
exists and then update it or create it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">(model) -&gt;</span>
    <span class="k">if</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span>
      <span class="nx">@update</span> <span class="nx">model</span>
    <span class="k">else</span>
      <span class="nx">@create</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><em>create</em> a  new model in the  collection. Backbone will fire  off <code>add</code> events
once this method is called. This will update the UI if they are hooked in.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">create: </span><span class="nf">(model) -&gt;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p><em>update</em>  an  existing model  in  the  collection.  Backbone will  fire  off
<code>change</code> events when this operation is made.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">update: </span><span class="nf">(model) -&gt;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">).</span><span class="nx">set</span> <span class="nx">model</span> </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p><em>delete</em> a model from the collection and remove the view.  The store will call view remove
because most models will be connected to a view, but will fail gracefully if it does not have
a model associated with it.  And then remove it from the collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">delete</span><span class="o">:</span> <span class="nf">(model) -&gt;</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">model</span> <span class="p">).</span><span class="nx">view</span><span class="o">?</span><span class="p">.</span><span class="nx">remove</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@collection</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="nx">model</span> <span class="p">)</span> </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h2>Backbone sync OVERRIDE</h2>

<p>The  sync method  is  what needs  to  be overridden  inorder  for backbone  to
communicate  with the  server. Again  all communication  is going  to go  over
<code>Faye</code> so all that  is needed here is to publish the  message accross the wire
and we are complete. The callbacks won't do anything right now due to how faye
handles communication.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Backbone.sync takes in the method that will be performed, the model that called the 
action, and two callbacks.  One for success and one for failure.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Backbone.sync = </span><span class="nf">(method, model, success, error) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This way  we well  will easily  know if  the client  is requesting  a single
object or an array of objects.
Grab the collection type so that we can perform operations on it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">fayeStorage</span><span class="o">?</span>
    <span class="nv">method           = </span><span class="s1">&#39;readAll&#39;</span>
    <span class="nv">store            = </span><span class="nx">model</span><span class="p">.</span><span class="nx">fayeStorage</span>
    <span class="nv">store.collection = </span><span class="nx">model</span>
  <span class="k">else</span>
    <span class="nv">store            = </span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">fayeStorage</span>
    <span class="nv">store.collection = </span><span class="nx">model</span><span class="p">.</span><span class="nx">collection</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Wrap what we want to send to the  server in an object NOTE: Other params may
be needed to help identify more about what is going on here.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">message = </span>
    <span class="nv">method: </span><span class="nx">method</span>
    <span class="nv">model: </span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Very simple  pass through  for the  faye server.  No work  is needed  on the
client side for any of the operations. We will just pass it through and then
update the records on the return message from the server.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">store</span><span class="p">.</span><span class="nx">write</span> <span class="nx">message</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 