<!DOCTYPE html>  <html> <head>   <title>backbone-faye-server-store.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="backbone-faye-client-store.html">                 backbone-faye-client-store.coffee               </a>                                           <a class="source" href="backbone-faye-server-store.html">                 backbone-faye-server-store.coffee               </a>                                           <a class="source" href="jquery.image-dropout.html">                 jquery.image-dropout.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="docco.html">                 docco.coffee               </a>                                           <a class="source" href="CoffeeSpec.html">                 CoffeeSpec.coffee               </a>                                           <a class="source" href="coffee_spec.html">                 coffee_spec.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-faye-server-store.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>EventEmitter is  Node.js events. Also pulling  in some other libs  to help out
with binding this with functions</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span> <span class="s1">&#39;events&#39;</span> <span class="p">).</span><span class="nx">EventEmitter</span>
<span class="nv">_und = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The Sync class will intercept messages from  the client and if they are on the
correct channel then we will</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Sync</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>When we create a new <code>Sync</code> class we are going to connect it to the database
and  hook up  some  events  when the  messages  are  received. Each  message
received  will fire  off an  event of  the same  name that  will need  to be
registered inorder to catch it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nv">redis  = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">)</span>
    <span class="vi">@client = </span><span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">()</span>
    <span class="nx">_und</span><span class="p">.</span><span class="nx">bindAll</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Hooking in to the <code>create</code> event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;create&#39;</span> <span class="p">,</span> <span class="nx">@create</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Hooking in to the <code>read</code> event </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;read&#39;</span>   <span class="p">,</span> <span class="nx">@read</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Hooking into the <code>readAll</code> event ( NOTE: this will call the <code>read</code> event )</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;readAll&#39;</span> <span class="p">,</span> <span class="nx">@readAll</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Hooking into the <code>update</code> event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;update&#39;</span> <span class="p">,</span> <span class="nx">@update</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Hooking into the <code>delete</code> event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@on</span> <span class="s1">&#39;delete&#39;</span> <span class="p">,</span> <span class="nx">@delete</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Here we are going  to take in a <code>NodeAdapter</code> and add  this as an extention.
This will allow us to be completelty self contained</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind: </span><span class="nf">(bayeux) -&gt;</span>
    <span class="vi">@bayeux = </span><span class="nx">bayeux</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">addExtension</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>The <code>incoming</code> function is an extention  of Faye. This function allows us to
view all  messages comming over the  faye stack and do  something with them.
The first thing we will want to do is filter out the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">incoming: </span><span class="nf">(message, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>By convention all messages that we  are looking for will match the pattern
of <code>/models/and_stuff_we_want</code>. So any channel that starts with <code>/models/</code>
( NOTE:  the slash  at the  start and  end ) we  will want  to keep  to do
something with.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">regex = </span><span class="sr">/^\/models\/(\w+)/</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Now test the channel with the given reg ex</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If we don't like this channel then use pass it through to the callback</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Now we know that the channel we are on is one we want to do something with
So we will fire off an event with  the name of the method ( e.g. <code>create</code>,
<code>read</code>, <code>update</code>, <code>destroy</code> ) and send along the data with it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@emit</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">model</span>
    </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>NOTE: we will also pass this message  along to the call back so others can
registers to the call back as well</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>All keys will have the similar pattern of <code>collection_name:id</code>.  This will ensure
that this pattern is followed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">key: </span><span class="nf">(base_key, model) -&gt;</span> <span class="s2">&quot;#{base_key}:#{model.id}&quot;</span>

  <span class="nv">create: </span><span class="nf">(base_key, model) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Create</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">incr</span> <span class="nx">base_key</span>

    <span class="nx">@client</span><span class="p">.</span><span class="nx">get</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nv">model.id = </span><span class="nx">obj</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">update</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span>

  <span class="nv">read: </span><span class="nf">(base_key, model) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Read</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">hgetall</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span>

  <span class="nv">readAll: </span><span class="nf">(base_key, collection) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Read All</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">base_key</span> <span class="o">+</span> <span class="s1">&#39;:*&#39;</span><span class="p">,</span> <span class="nf">(err,keys) -&gt;</span>
      <span class="nx">_und</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nf">(key) -&gt;</span> 
        <span class="nv">parts = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;:&#39;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span> <span class="nv">id : </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span>

  <span class="nv">update: </span><span class="nf">(base_key, model, method) -&gt;</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">hmset</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nx">model</span>
    <span class="nx">@publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">or</span> <span class="s1">&#39;update&#39;</span> <span class="p">)</span>

  <span class="k">delete</span><span class="o">:</span> <span class="nf">(base_key, model) -&gt;</span>
    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">del</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span>

  <span class="nv">publish: </span><span class="nf">(channel, data, action) -&gt;</span>
    <span class="nv">message = </span><span class="p">{</span> <span class="nv">model : </span><span class="nx">data</span> <span class="p">,</span> <span class="nv">method : </span><span class="nx">action</span> <span class="p">}</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">getClient</span><span class="p">().</span><span class="nx">publish</span> <span class="s2">&quot;/server/models/#{channel}&quot;</span><span class="p">,</span> <span class="nx">message</span>

<span class="nv">exports.Sync = </span><span class="nx">Sync</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 