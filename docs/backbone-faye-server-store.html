<!DOCTYPE html>  <html> <head>   <title>backbone-faye-server-store.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="app.html">                 app.coffee               </a>                                           <a class="source" href="backbone-faye-client-store.html">                 backbone-faye-client-store.coffee               </a>                                           <a class="source" href="faye-client-auth.html">                 faye-client-auth.coffee               </a>                                           <a class="source" href="jquery.image-dropout.html">                 jquery.image-dropout.coffee               </a>                                           <a class="source" href="backbone-faye-server-store.html">                 backbone-faye-server-store.coffee               </a>                                           <a class="source" href="faye.ad.html">                 faye.ad.coffee               </a>                                           <a class="source" href="server.html">                 server.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone-faye-server-store.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>The Sync</h2>

<p>The  <code>Sync</code>  class  will  handle  the  <em>CRUD</em>  from  the  server.  I  will  be
intercepting any channel that begins with <code>models</code> then followed by the name of
the collection to perform the <em>CRUD</em>  actions on. <code>Sync</code> uses <code>redis</code> for it's
persistence layer</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Util for the <code>Sync</code> class</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_und = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span>
<span class="k">class</span> <span class="nx">Sync</span>
  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>When we create a new <code>Sync</code> class we are going to connect it to the database
and  hook up  some  events  when the  messages  are  received. Each  message
received  will fire  off an  event of  the same  name that  will need  to be
registered inorder to catch it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="nv">redis   = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;redis&#39;</span><span class="p">)</span>
    <span class="vi">@client = </span><span class="nx">redis</span><span class="p">.</span><span class="nx">createClient</span><span class="p">()</span>
    <span class="nx">_und</span><span class="p">.</span><span class="nx">bindAll</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Here we are going  to take in a <code>faye</code> object and add  this as an extention.
This will allow us to be completelty self contained and self managed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind: </span><span class="nf">(bayeux) -&gt;</span>
    <span class="vi">@bayeux = </span><span class="nx">bayeux</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">addExtension</span> <span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The <code>incoming</code> function is an extention  of Faye. This function allows us to
view all  messages comming over the  faye stack and do  something with them.
The first thing we will want to do is filter out the message.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">incoming: </span><span class="nf">(message, callback) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>By convention all messages that we  are looking for will match the pattern
of <code>/models/and_stuff_we_want</code>. So any channel that starts with <code>/models/</code>
will be processed in the <em>CRUD</em> operations.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">regex = </span><span class="sr">/^\/models\/(\w+)/</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Now test the channel with the given reg ex</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">unless</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">test</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If we don't like this channel then use pass it through to the callback</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Now we know that the channel we are on is one we want to do something with
So we will call  a method with on the <code>Sync</code> class that  has the same name
as  the action  that is  giong to  be performed  ( e.g.  <code>create</code>, <code>read</code>,
<code>update</code>, <code>destroy</code> ) and send along the data with it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="err">@</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">method</span><span class="p">]</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span> <span class="nx">message</span><span class="p">.</span><span class="nx">channel</span> <span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">model</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>NOTE: we will also pass this message  along to the call back so others can
registers to the call back as well.  This is important in <code>faye</code> as to not
block the communication</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">callback</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>All keys will have the similar pattern of <code>collection_name:id</code>.  This will ensure
that this pattern is followed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">key: </span><span class="nf">(base_key, model) -&gt;</span> <span class="s2">&quot;#{base_key}:#{model.id}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Create</h3>

<p>The <em>C</em> in CRUD.  Create a new object in the redis db.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">create: </span><span class="nf">(base_key, model) -&gt;</span>
    <span class="nv">that = </span><span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Get the next id</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@client</span><span class="p">.</span><span class="nx">incr</span> <span class="nx">base_key</span>

    <span class="nx">@client</span><span class="p">.</span><span class="nx">get</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nv">model.id = </span><span class="nx">obj</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">update</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>Read</h3>

<p>Pull a  single record out  of the database  and send it  on it's way  to all
clients. There  is no <code>read  all</code> records. It turns  into a bunch  of single
reads. This is due to keeping things simple for version one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">read: </span><span class="nf">(base_key, model) -&gt;</span>
    <span class="nv">that = </span><span class="err">@</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>The data is stored  in a hash ( which is great for  objects ). Here we are
pulling all fields for that hash and publishing them back to ALL clients.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@client</span><span class="p">.</span><span class="nx">hgetall</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">obj</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Read All</h3>

<p>Find all of the keys for this collection and read the back to the client one
by one. reusing as much code as possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">readAll: </span><span class="nf">(base_key, collection) -&gt;</span>
    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">base_key</span> <span class="o">+</span> <span class="s1">&#39;:*&#39;</span><span class="p">,</span> <span class="nf">(err,keys) -&gt;</span>
      <span class="nx">_und</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">keys</span><span class="p">,</span> <span class="nf">(key) -&gt;</span> 
        <span class="nv">parts = </span><span class="nx">key</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;:&#39;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{</span> <span class="nv">id : </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>Update</h3>

<p>Update a single model.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">update: </span><span class="nf">(base_key, model, method) -&gt;</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">hmset</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nx">model</span>
    <span class="nx">@publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="p">(</span> <span class="nx">method</span> <span class="o">or</span> <span class="s1">&#39;update&#39;</span> <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Delete</h3>

<p>Delete a single model</p>             </td>             <td class="code">               <div class="highlight"><pre>  
  <span class="k">delete</span><span class="o">:</span> <span class="nf">(base_key, model) -&gt;</span>
    <span class="nv">that = </span><span class="err">@</span>
    <span class="nx">@client</span><span class="p">.</span><span class="nx">del</span> <span class="nx">@key</span><span class="p">(</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span> <span class="p">),</span> <span class="nf">(err,obj) -&gt;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">base_key</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Publish</h3>

<p>Publish a  model back  to the  collection. NOTE: this  is using  a different
channel to publish back on. We are  using two channels so that we won't read
on this channel and have a nice little loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">publish: </span><span class="nf">(channel, data, action) -&gt;</span>
    <span class="nv">message = </span><span class="p">{</span> <span class="nv">model : </span><span class="nx">data</span> <span class="p">,</span> <span class="nv">method : </span><span class="nx">action</span> <span class="p">}</span>
    <span class="nx">@bayeux</span><span class="p">.</span><span class="nx">getClient</span><span class="p">().</span><span class="nx">publish</span> <span class="s2">&quot;/server/models/#{channel}&quot;</span><span class="p">,</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Expose the <code>Sync</code> class to the outside world</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Sync = </span><span class="nx">Sync</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 